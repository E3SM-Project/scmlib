## Documentation: ARM/ASR Diagnostics Package for E3SM SCM and DP-EAMxx

This is a diagnostics package for the E3SM SCM and Doubly-Periodic Configuration of EAMxx (DP-EAMxx).

This diagnostics package is used by selecting the example script:

`diagnostics_user_driver.py`

Make a copy of this, which will be ignored by git.  This script then needs to be edited to add
the relevant datasets, case specifics, observation files, and plotting styles to fit the user's needs.
The new user script can then be executed after loading the suitable environment (see Setup Notes).

Development of this diagnostics package was primarily supported by the Atmospheric System Research program, Tying in High Resolution E3SM with ARM Data (THREAD) project (SCW1800), and partially supported by the Atmospheric Radiation Measurement (ARM) program and the Energy Exascale Earth System Model (E3SM) project, all funded by the U.S. Department of Energy (DOE), Office of Science, Office of Biological and Environmental Research.

--------------------------------------------------------------------------------

## TABLE OF CONTENTS
  - [Package Overview](#package-overview)
  - [Setup Notes](#setup-notes)
  - [Valid E3SM SCM Input Data](#valid-e3sm-scm-input-data)
  - [Valid DP-EAMxx Input Data](#valid-dp-eamxx-input-data)
  - [Observation and LES Datasets](#observation-and-les-datasets)
  - [Adding Datasets](#adding-datasets)
  - [User Specifications](#user-specifications)
  - [Development Plans](#development-plans)

--------------------------------------------------------------------------------

## Package Overview

This diagnostics package is designed to provide users with a simple, user-friendly interface for quickly evaluating process-level simulations using the E3SM SCM and DP-EAMxx configurations. It also facilitates straightforward comparisons with ARM observations and large eddy simulation (LES) results, where available. The package is not intended for generating publication-quality figures or performing advanced analysis. Rather, it offers a basic suite of plots to help users quickly assess the fidelity of their simulations and identify areas for more detailed investigation.  If you include figures generated by this package in a presentation, we kindly ask that you acknowledge the package as the source.

Example:
The [example driver file](https://github.com/E3SM-Project/scmlib/blob/master/Diagnostics_Package/diagnostics_user_driver.py) will produce the following [diagnostic output](https://portal.nersc.gov/cfs/e3sm/bogensch/Official_Example_Diags/MAGIC_dpxx_bug_fix/). 

--------------------------------------------------------------------------------

## Setup Notes

It is recommended to use the E3SM unified environment to run this package.

On Perlmutter:

`source /global/common/software/e3sm/anaconda_envs/load_latest_e3sm_unified_pm-cpu.sh`

On Chrysalis:

`source /lcrc/soft/climate/e3sm-unified/load_latest_e3sm_unified_chrysalis.sh`

Alternatively a user can create their own environment, if they wish.  The following packages would be needed in such an environment:
  ```
  conda create --name e3sm_asr_diag python=3.10 -c conda-forge xarray numpy matplotlib jinja2 netCDF4 scipy 
  ```
After creating the environment it can be activated via:

  `source activate e3sm_asr_diag`

--------------------------------------------------------------------------------

## Valid E3SM SCM Input Data

The default output generated by the E3SM SCM in the `*.eam.h0.*` file can be used directly. 

For vertical coordinates, please ensure you are outputting the variables `Z3` and `PS`, which are included by default in the standard `*eam.h0.*` files. If these variables are not included, the diagnostics package will use the reference pressure coordinate for plotting, which may not be accurate when comparing against observational or LES datasets.

Ideally, all diagnostic variables will be contained in a single NetCDF output file.  Within each output stream all variables must share a common time coordinate. If you have multiple output streams, each with different time coordinates, then each output stream must be added to the diagnostics package as an individual [dataset](#adding-datasets). Note that the default E3SM SCM output can be customized, additional variables can be added as needed to tailor the output to your specific analysis needs.

--------------------------------------------------------------------------------

## Valid DP-EAMxx Input Data

A valid DP-EAMxx dataset should be horizontally averaged by using the EAMxx `_horiz_avg` reducer.  [This is an example of a YAML file](https://github.com/E3SM-Project/scmlib/blob/master/DPxx_SCREAM_SCRIPTS/yaml_file_example/scream_horiz_avg_output_15min.yaml) that can be used in your DP-EAMxx run and will produce a compatible output stream to be used in the DP-EAMxx diagnostics package.  Ideally, all diagnostic variables will be contained in a single NetCDF output file.  Within each output stream all variables must share a common time coordinate. If you have multiple output streams, each with different time coordinates, then each output stream must be added to the diagnostics package as an individual [dataset](#adding-datasets). 

For vertical coordinates, please ensure you are outputting the variables `zmid_horiz_avg` and `ps_horiz_avg` to your output stream. Failure to do so will force the diagnostics package to plot using the reference pressure coordinate, which will likely not be accurate if you are comparing against observational or LES datasets.

Doing averaging offline on a DP-EAMxx output stream and supplying that dataset may work with the package, but comes with no warranty of working at this time.  

## Observation and LES Datasets

We have created a database of observation and LES datasets that can be directly compared to E3SM SCM and DP-EAMxx simulations. A user simply needs to point to the correct file for their case for it to be included in the package. This database includes ARM observations, ERA5 reanalysis and analysis, and results from various LES. No processing of this data is needed; it is ready to compare with E3SM SCM and DP-EAMxx simulations.

The database is officially stored on the E3SM data server at:

```
https://web.lcrc.anl.gov/public/e3sm/diagnostics/observations/Atm/scm_dpxx_datasets/
```

This location is world-readable with no restrictions. Users may download the required datasets to their personal directories.  

Alternatively, the data is installed on Perlmutter (NERSC) at:

```
/global/cfs/cdirs/e3sm/diagnostics/observations/Atm/scm_dpxx_datasets/
```

and will be kept up to date as changes or additions are made to the datasets. We plan to install the data on other commonly used E3SM machines in the near future.

The `scm_dpxx_datasets` folder contains two subfolders, one for `E3SM_SCM` and the other for `DP_EAMxx`. Each folder contains the exact same datasets and data; the only differnce is the format of the data for the respective model configuration. Please point to the dataset that corresponds to your case and model configuration.  

An example file format: `<CASE>.<data_type>.<source>.<format>.nc`  

```
Example: CASS.les.SAM.dpxx_format.nc
Case = CASS (should match the SCM/DP-EAMxx case that you ran)
data_type = les (large eddy simulation)
source = SAM (System for Atmospheric Modeling)
format = dpxx_format (processed for  DP-EAMxx)
```
We anticipate that this dataset will grow rapidly over the coming months, with near-term plans to add ARM Best Estimate (ARMBE) datasets for several sites.

--------------------------------------------------------------------------------

## Adding Datasets

You can include as many datasets as you'd like, whether they are model simulations, observational datasets, or LES output. To add a dataset, edit the appropriate section of your `diagnostics_user_driver.py` file, where example entries are provided. For each dataset, please supply the following information:

```
# SCREAM control simulation
datasets.append({
"filename": "{path_to_your_dataset}/run/scream_dpxx_MAGIC.control.001a.horiz_avg.AVERAGE.nmins_x15.2013-07-21-19620.nc"),
"short_id": "Control",
"line_color": "blue",
"line_style": "-"
})
```
You must provide the file path, a short id (to be used for plot legends), and specify both a line color and line style for all profile and time series plots.  [Please see list of valid python colors](https://matplotlib.org/stable/gallery/color/named_colors.html).

Observational and LES datasets should be added in the same way. For inforamtion on where to obtain supported observation or LES files, please see the section above.

```
# Sounding observation dataset
datasets.append({
"filename": "{path_to_obs_output}/DP_EAMxx/MAGIC.obs.sounding.dpxx_format.nc",
"short_id": "Sounding Obs.",
"line_color": "gray",
"line_style": "--"
})
```
Note that in this example, since we are analyzing a DP-EAMxx simulation, the observation file must be in the appropriate format (i.e. must end in `*dpxx_format.nc`).

It IS possible to run the diagnostic package with mixed E3SM SCM and DP-EAMxx simulations.  However, if you want variables to coincide with each other, then you must pick one format for all datasets. This will result in you converting your DP-EAMxx simulations to E3SM SCM format or vice versa. Scripts are provided in this package to do this:

[Script to convert DP-EAMxx model output format to E3SM SCM format](https://github.com/E3SM-Project/scmlib/blob/master/Diagnostics_Package/convert_OBS_LES_output/DPxx_to-from_E3SM_format/DPxx_to_E3SM.py)

[Script to convert E3SM SCM model output to DP-EAMxx format](https://github.com/E3SM-Project/scmlib/blob/master/Diagnostics_Package/convert_OBS_LES_output/DPxx_to-from_E3SM_format/E3SM_to_DPxx.py)

--------------------------------------------------------------------------------

## User Specifications

Below is a description of customizable user-defined options. In general, the `iop_diagnostic_driver.py` example file should provide sufficient comments to guide your choices, but they are expanded here.

#### Choosing a Height Coordinate

Users can choose to plot in pressure or height coordinates. See the input data requirements for plotting in `p` vs `z`.

```
# Choose vertical plotting coordinate; can be pressure or height.
#  -If height then the variable Z3 (E3SM) or z_mid (EAMxx) needs to be in your output file.
#  -If pressure then PS (E3SM) or ps (EAMxx) should be in your output file.  If it is not then
#    the package will use hybrid levels to plot, which may not be accurate compared to observations.
height_cord = "z"  # p = pressure; z = height
```

Note that some observational/LES datasets ONLY have eithe `p` or `z`. Thus, if you want to compare against a particular dataset, ensure that dataset has the appropriate coordinates and select accordingly. Note that we are aware that it is not obvious what coordiantes exist in each reference dataset without doing an ncdump. We will document this better in the near future.

#### Profile Averaging Windows

A user can add as many temporal averaging windows as they want for their simulation.  For instance, assuming that a simulation is three days in length, an example is (units in days):

```
profile_time_s = [0.0,0.0,1.0,2.0]  # Starting times for averaging (units in days)
profile_time_e = [3.0,1.0,2.0,3.0]  # Ending times for averaging
```
This will produce four pages of averaging windows. The first page will produce profiles plots averaged over all three days, while the second averaging window will produce profile plots averaged over the first simulated day, etc.  

Units are in days, so if a user wants to specify in hours, simply divide by 24. This is useful if your case is only a few hours in length (i.e. DYCOMS-RF01) or you want to target a specific period:

```
profile_time_s = [0.0,   3./24.]  # Starting times for averaging (units in days)
profile_time_e = [4./24.,4./24.]  # Ending times for averaging
```
The above example averages over the first four hours of the simulation for the first averaging window, then over hours 3 to 4 for the second averaging window.

#### Select Maximum Plotting Height and Times

A series of options exist so that you can restrict the plotting height. This is particularly useful for boundary layer cloud regimes, where the area of interest is restricted to the lowest model layers. Please see the following options:

```
# Optional: Maximum y-axis height for profile plots (in meters or mb; depending on vertical coordinate)
max_height_profile = 3000  # Set to desired height in meters or mb, or None for automatic scaling

# Optional: Maximum y-axis height for time-height (in meters or mb; depending on vertical coordinate)
max_height_timeheight = 3000  # Set to desired height in meters or mb, or None for automatic scaling
```

and for time range restrictions for time series plots and time height plots:
```
# Optional: Time range for time series plots in days
time_series_time_s = 0  # Starting time for time series, None for default (entire range)
time_series_time_e = 3.25  # Ending time for time series, None for default (entire range)

# Optional: Time range for time-height plots in days
time_height_time_s = 0  # Starting time for time-height plots, None for default (entire range)
time_height_time_e = 3.25  # Ending time for time-height plots, None for default (entire range)
```

#### Plotting Aesthetics Controls

You can increase or decrease the linewidth, control the sizes of your ticks and labels, and control the colormap for 2D plots. Please see the following options and their default settings:

```
# linewidth for curves
linewidth = 4
```
```
# Optional arguments to define tick size and label size for plots.  Default is 14.
ticksize=14
labelsize=14
```
```
# Define the colormap for time height contourf plots.  Default is "viridis_r".
time_height_cmap = "viridis_r"
```

#### Diurnal Composite Plots

If your dataset has at least three days' worth of data, with at least four output time slices per day, then you have the option of producing 1D and 2D diurnal composite plots by activating the following:

```
# Do Diurnal Composite Analysis?  Must have at least three days worth of data and each
#  day must have at least 4 output time slices for this analysis to be considered.
do_diurnal_composites = False
diurnal_start_day = None  # Starting day for diurnal composite stats, None for default (entire range)
diurnal_end_day = None    # Ending day for diurnal composite stats, None for default (entire range)
```
--------------------------------------------------------------------------------

## Development Plans

At a future date, we plan to add more quantitative metrics such as skill scores and Taylor diagrams, for example. If you would like to see a particular feature added, please contact Peter Bogenschutz at bogenschutz1@llnl.gov.

